<!DOCTYPE html>
<html>
  <head>
      <meta charset="utf-8">
      <meta name="format-detection" content="telephone=no">
      <meta name="msapplication-tap-highlight" content="no">
      <meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover">
      <link rel="stylesheet" href="css/fontawesome.css">
      <link rel="stylesheet" href="css/solid.css">
      <link rel="stylesheet" href="css/bootstrap.css">
      <link rel="stylesheet" href="css/index.css">
      <script src="cordova.js"></script>
  </head>
  <body class="bg-light">
    <!-- Barra superior -->
    <div class="sticky-top bg-primary d-flex flex-wrap p-2">
      <div class="col-6">
        <p class="m-2 h4"><a href="categorias.html"><i class="fa-solid fa-arrow-left"></i></a><span id="titulo"></span></p>
      </div>
      <div class="text-end col-6">
        <button id="buscar" class="btn btn-secondary me-1"><i class="fas fa-search"></i></button>
        <button data-bs-toggle="modal" data-bs-target="#modalCEjercicio" class="btn btn-primary me-1"><i class="fas fa-plus"></i></button>
      </div>
      <div id="busqueda" class="input-group sticky-top my-2 px-4" style="display:none">
        <div class="input-group-prepend">
          <span class="input-group-text bg-primary" id="basic-text1"><i class="fas fa-search text-white" aria-hidden="true"></i></span>
        </div>
        <input class="form-control py-1" id="search_text" type="text" placeholder="Buscar ejercicio" aria-label="Search">
      </div>
    </div>
    <!-- Fin barra superior -->

    <!-- Filtrado -->
    <div id="filtrado" class="px-4 my-2 row overflow-scroll flex-nowrap vw-100">
      <div class="w-auto p-1">
        <input type="checkbox" class="btn-check" id="btn-favoritos">
        <label class="btn btn-primary" for="btn-favoritos"><i class="fa-solid fa-star"></i></label>
      </div>
      <div class="w-auto p-1">
        <input type="checkbox" class="btn-check" id="btn-ocultos">
        <label class="btn btn-primary" for="btn-ocultos"><i class="fa-solid fa-eye-slash"></i></label>
      </div>
    </div>
    <!-- Fin filtrado -->

    <div id="ejercicios" class="mb-5"></div>

    <!-- Modal nuevo ejercicio -->
    <div class="modal fade" id="modalCEjercicio" tabindex="-1" aria-labelledby="modalCEjercicioLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="modalCEjercicioLabel">Crear ejercicio</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="input-group mb-2">
              <input type="text" class="form-control" autofocus placeholder="Nombre del ejercicio:" name="nombre" id="nombre" />
            </div>
            <div class="input-group mb-2">
              <select class="form-select" id="tipo" name="tipo">
              </select>
              <select class="form-select" id="metrica" name="metrica">
              </select>
            </div>
            <div class="input-group mb-2">
              <select class="form-select" id="categoria" name="categoria">
              </select>
              <button id="btn-musculos" class="btn btn-primary">Músculos</button>
            </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="cEjercicio()" data-bs-dismiss="modal">Guardar</button>
          </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Fin modal nuevo ejercicio -->

    <!-- Modal editar ejercicio -->
    <div class="modal fade" id="modalUEjercicio" tabindex="-1" aria-labelledby="modalUEjercicioLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h1 id="titulo"class="modal-title fs-5">Editar ejercicio</h1>
              <p id="subtitulo" class="fst-italic modal-title"></p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="input-group mb-2">
              <input type="text" class="form-control" autofocus placeholder="Nombre del ejercicio:" name="nombre" id="nombreE" />
            </div>
            <div class="input-group mb-2">
              <select class="form-select" id="tipoE" name="tipo">
              </select>
              <select class="form-select" id="metricaE" name="metrica">
              </select>
            </div>
            <div class="input-group mb-2">
              <select class="form-select" id="categoriaE" name="categoria">
              </select>
              <button class="btn btn-primary">Músculos</button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="uEjercicio()" data-bs-dismiss="modal">Actualizar</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Fin modal editar ejercicio -->

    <!-- Modal borrar ejercicio -->
    <div class="modal fade" id="modalDEjercicio" tabindex="-1" aria-labelledby="modalDEjercicioLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="modalDEjercicioLabel"></h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>¡Se eliminará el ejercicio y todos sus entrenamientos!</p>
            <p>Si sólo quieres que no te aparezca en pantalla, puedes ocultarlo.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary"><a class="text-decoration-none" id="eliminar">Eliminar</a></button>
          </div>
        </div>
      </div>
    </div>
    <!-- Fin modal borrar ejercicio -->

    <!-- Barra inferior -->
    <div class="align-items-center mh-45px fixed-bottom bg-primary p-2 d-flex justify-content-around vw-100" w3-include-html="footer.html"></div>
    <script src="js/footer.js"></script>
    <script>includeHTML();</script>
    <!-- Fin  barra inferior -->
    
    <!-- <script src="js/index.js"></script> -->
    <script src="js/db.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="js/bootstrap.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script>
      document.addEventListener('deviceready', async function() {
        // Conexión, insertar metricas, tipos y ejercicios
        const db = conexion();

        const musculos = await getMusculos(db);
        const tipos = await getTipos(db);
        const metricas = await getMetricas(db);
        const categorias = await getCategorias(db);
        // Obtengo el parámetro get grupo_muscular para hacer la consulta de los ejercicios correspondientes
        const urlParams = new URLSearchParams(window.location.search);
        const grupo_muscular_id = urlParams.get('grupo_muscular');

        // Modales y su lógica
        const modalCEjercicio = document.getElementById('modalCEjercicio')
        const modalUEjercicio = document.getElementById('modalUEjercicio')
        const inputTipoC = modalCEjercicio.querySelector('#tipo')
        const inputTipoE = modalUEjercicio.querySelector('#tipoE')
          for (let i = 0; i < tipos.rows.length; i++) {
            let tipo_id = tipos.rows.item(i).ID
            let tipo = tipos.rows.item(i).tipo
            opcionTipoC = document.createElement("option")
            opcionTipoC.id = "tipo"+tipo_id
            opcionTipoC.value = tipo_id
            opcionTipoC.textContent = tipo
            opcionTipoE = document.createElement("option")
            opcionTipoE.id = "tipo"+tipo_id
            opcionTipoE.value = tipo_id
            opcionTipoE.textContent = tipo
            inputTipoC.appendChild(opcionTipoC)
            inputTipoE.appendChild(opcionTipoE)
          }
          const inputMetricaC = modalCEjercicio.querySelector('#metrica')
        const inputMetricaE = modalUEjercicio.querySelector('#metricaE')
        for (let i = 0; i < metricas.rows.length; i++) {
          let metrica_id = metricas.rows.item(i).ID
          let metrica = metricas.rows.item(i).metrica
          opcionMetrica = document.createElement("option")
          opcionMetrica.id = "metrica"+metrica_id
          opcionMetrica.value = metrica_id
          opcionMetrica.textContent = metrica
          inputMetricaC.appendChild(opcionMetrica)
          inputMetricaE.appendChild(opcionMetrica)
        }
        const inputCategoriaC = modalCEjercicio.querySelector('#categoria')
        const inputCategoriaE = modalUEjercicio.querySelector('#categoriaE')
        for (let i = 0; i < categorias.rows.length; i++) {
          let categoria_id = categorias.rows.item(i).ID
          let categoria = categorias.rows.item(i).nombre
          opcionCategoria = document.createElement("option")
          opcionCategoria.id = "categoria"+categoria_id
          opcionCategoria.value = categoria_id
          opcionCategoria.textContent = categoria
          inputCategoriaC.appendChild(opcionCategoria)
          inputCategoriaE.appendChild(opcionCategoria)
        }
        modalCEjercicio.addEventListener('show.bs.modal', async event => {
          const boton = event.relatedTarget
          $("#categoria"+grupo_muscular_id).attr("selected","selected");
        });

        modalUEjercicio.addEventListener('shown.bs.modal', async event => {
          const boton = event.relatedTarget
          const idEjercicio = boton.getAttribute('data-bs-ejercicio')
          let ejercicio = await getEjercicios(db,`WHERE ID = ${idEjercicio}`);
          const subtitulo = modalUEjercicio.querySelector('#subtitulo')
          subtitulo.textContent = ejercicio.rows.item(0).nombre;
          const inputNombre = modalUEjercicio.querySelector('#nombreE')
          inputNombre.value = ejercicio.rows.item(0).nombre;
          inputNombre.setAttribute("ejercicio",ejercicio.rows.item(0).ID);
          $("#categoriaE"+ejercicio.rows.item(0).grupo_muscular).attr("selected","selected");
          $("#tipoE"+ejercicio.rows.item(0).tipo).attr("selected","selected");
          $("#metricaE"+ejercicio.rows.item(0).metrica).attr("selected","selected");
        });

        const modalDEjercicio = document.getElementById('modalDEjercicio')
        modalDEjercicio.addEventListener('show.bs.modal', async event => {
          const boton = event.relatedTarget
          const idEjercicio = boton.getAttribute('data-bs-ejercicio')
          const ejercicio = await getEjercicios(db,`WHERE ID = ${idEjercicio}`)
          const modalTitle = modalDEjercicio.querySelector('.modal-title')
          modalTitle.textContent = ejercicio.rows.item(0).nombre;
          const modalLink = modalDEjercicio.querySelector('#eliminar')
          modalLink.href = "ejercicios.html?grupo_muscular="+grupo_muscular_id+"&eliminar="+idEjercicio;
        });
        if(urlParams.get('eliminar') != null){
          borrarEjercicio(db,urlParams.get('eliminar'));
        }
        if(urlParams.get('ocultar') != null){
          ocultarEjercicio(db,urlParams.get('ocultar'));
        }
        if(urlParams.get('favoritoS') != null){
          aFavoritoEjercicio(db,urlParams.get('favoritoS'));
        }
        if(urlParams.get('favoritoN') != null){
          qFavoritoEjercicio(db,urlParams.get('favoritoN'));
        }

        // Cojo el nombre del grupo muscular para cambiar el título de la ventana
        const grupo_muscular = await getCategorias(db,`WHERE ID = ${grupo_muscular_id}`);
        const nombre_grupo_muscular = grupo_muscular.rows.item(0).nombre;
        $('#titulo').text(" " + nombre_grupo_muscular);

        // Filtrado
        // const musculosCategoria = await getMusculos(db,`WHERE grupo_muscular = ${grupo_muscular_id}`);
        // for (let i = 0; i < musculosCategoria.rows.length; i++) {
        //   let musculo = musculosCategoria.rows.item(i);
        //   let divFiltrado = document.createElement('div');
        //   divFiltrado.classList.add('w-auto', 'p-1');
        //   let inputFiltrado = document.createElement('input');
        //   inputFiltrado.type = 'checkbox';
        //   inputFiltrado.classList.add('btn-check');
        //   inputFiltrado.id = 'btn-' + musculo.nombre;
        //   let labelFiltrado = document.createElement('label');
        //   labelFiltrado.classList.add('btn', 'btn-primary');
        //   labelFiltrado.htmlFor = 'btn-' + musculo.nombre;
        //   labelFiltrado.textContent = musculo.nombre;
        //   divFiltrado.appendChild(inputFiltrado);
        //   divFiltrado.appendChild(labelFiltrado);
        //   document.getElementById("filtrado").appendChild(divFiltrado);
        // }
        // for(let i = 0; i < tipos.rows.length; i++){
        //   let tipo = tipos.rows.item(i);
        //   let divTipos = document.createElement('div');
        //   divTipos.classList.add('w-auto', 'p-1');
        //   let inputTipos = document.createElement('input');
        //   inputTipos.type = 'checkbox';
        //   inputTipos.classList.add('btn-check');
        //   inputTipos.id = 'btnTipo-' + i;
        //   let labelTipos = document.createElement('label');
        //   labelTipos.classList.add('btn', 'btn-tipos', 'btn-secondary');
        //   labelTipos.htmlFor = 'btnTipo-' + i;
        //   labelTipos.textContent = tipo.tipo;
        //   divTipos.appendChild(inputTipos);
        //   divTipos.appendChild(labelTipos);
        //   document.getElementById("filtrado").appendChild(divTipos);
        // }

        // Lista de ejercicios
        const ejercicios = await getEjercicios(db,`WHERE grupo_muscular = ${grupo_muscular_id} AND oculto = 0`);
        for (let i = 0; i < ejercicios.rows.length; i++) {
            let ejercicio = ejercicios.rows.item(i);
            let divPrincipal = document.createElement("div");
            divPrincipal.classList.add("px-4", "my-2");
            let divInterno = document.createElement("div");
            divInterno.classList.add("bg-white", "rounded", "shadow-sm", "p-3", "row", "align-items-center");
            let columna1 = document.createElement("div");
            columna1.classList.add("col-4");
            let imagen = document.createElement("img");
            imagen.classList.add("rounded-circle", "shadow", "img-fluid");
            imagen.src = ejercicio.imagen;
            columna1.appendChild(imagen);
            divInterno.appendChild(columna1);
            let columna2 = document.createElement("div");
            columna2.classList.add("col-8");
            let filaInterna = document.createElement("div");
            filaInterna.classList.add("row");
            let columna1FilaInterna = document.createElement("div");
            columna1FilaInterna.classList.add("col-10");
            let parrafo = document.createElement("p");
            let strong = document.createElement("strong");
            let u = document.createElement("u");
            let textoParrafo = document.createTextNode(ejercicio.nombre);
            u.appendChild(textoParrafo);
            strong.appendChild(u);
            parrafo.appendChild(strong);
            columna1FilaInterna.appendChild(parrafo);
            filaInterna.appendChild(columna1FilaInterna);
            let columna2FilaInterna = document.createElement("div");
            columna2FilaInterna.classList.add("col-2");
            let dropdown = document.createElement("div");
            dropdown.classList.add("dropdown");
            let boton = document.createElement("button");
            boton.classList.add("btn");
            boton.setAttribute("type", "button");
            boton.setAttribute("data-bs-toggle", "dropdown");
            boton.setAttribute("aria-expanded", "false");
            let icono = document.createElement("i");
            icono.classList.add("fa-solid", "fa-ellipsis-vertical");
            boton.appendChild(icono);
            dropdown.appendChild(boton);
            let lista = document.createElement("ul");
            lista.classList.add("dropdown-menu");
            let elementosLista = [
                { href: `ejercicios.html?ejercicio=${ejercicio.ID}`, clase: "infoEjercicio", icono: "fa-info-circle", texto: " Información" },
                { href: `estadisticas.html?ejercicio=${ejercicio.ID}`, clase: "estadisticasEjercicio", icono: "fa-chart-line", texto: " Estadísticas" },
                { clase: "editarEjercicio", icono: "fa-pencil", texto: " Editar", modal: "modalUEjercicio", atributo: "data-bs-ejercicio", valorAtributo: ejercicio.ID },
                { clase: "eliminarEjercicio", icono: "fa-trash-can", texto: " Eliminar", modal: "modalDEjercicio", atributo: "data-bs-ejercicio", valorAtributo: ejercicio.ID }
              ];
            if(ejercicio.oculto == 0){
              elementosLista.push({ href: `ejercicios.html?grupo_muscular=${grupo_muscular_id}&ocultar=${ejercicio.ID}`, clase: "ocultarEjercicio", icono: "fa-eye-slash", texto: " Ocultar" });
            }
            else{
              elementosLista.push({ href: `ejercicios.html?grupo_muscular=${grupo_muscular_id}&mostrar=${ejercicio.ID}`, clase: "mostrarEjercicio", icono: "fa-eye", texto: " Mostrar" });
            }
            if(ejercicio.favorito == 0){
              elementosLista.push({ href: `ejercicios.html?grupo_muscular=${grupo_muscular_id}&favoritoS=${ejercicio.ID}`, clase: "favoritoSEjercicio", icono: "fa-star", texto: " Favorito" });
            }
            else{
              elementosLista.push({ href: `ejercicios.html?grupo_muscular=${grupo_muscular_id}&favoritoN=${ejercicio.ID}`, clase: "favoritoNEjercicio", icono: "fa-xmark", texto: " Quitar favorito" });
            }
            elementosLista.forEach(function(elemento) {
              let itemLista = document.createElement("li");
              let enlace = document.createElement("a");
              enlace.href = elemento.href || "#";
              enlace.classList.add("dropdown-item", elemento.clase);
              let iconoLista = document.createElement("i");
              iconoLista.classList.add("fa-solid", elemento.icono);
              let textoEnlace = document.createTextNode(elemento.texto);
              enlace.appendChild(iconoLista);
              enlace.appendChild(textoEnlace);
              itemLista.appendChild(enlace);
              lista.appendChild(itemLista);
              if (elemento.modal) {
                  enlace.setAttribute("data-bs-toggle", "modal");
                  enlace.setAttribute("data-bs-target", "#" + elemento.modal);
                  enlace.setAttribute(elemento.atributo, elemento.valorAtributo);
              }
            });
            dropdown.appendChild(lista);
            columna2FilaInterna.appendChild(dropdown);
            filaInterna.appendChild(columna2FilaInterna);
            columna2.appendChild(filaInterna);
            divInterno.appendChild(columna2);
            divPrincipal.appendChild(divInterno);
            document.getElementById("ejercicios").appendChild(divPrincipal);
        }
      },false);
      $(document).ready(function(){
        $("#buscar").on( "click", function() {
          $("#busqueda").slideToggle("fast");
        })
      });
      function uEjercicio(){
        let datos = [$("#nombreE").attr("ejercicio"),$("#nombreE").val(),$("#tipoE").val(),$("#metricaE").val(),$("#categoriaE").val()]
        actualizarEjercicio(db,datos)
        location.reload()
      }
      function cEjercicio(){
        let datos = [$("#nombre").val(),$("#tipo").val(),$("#metrica").val(),$("#categoria").val()]
        crearEjercicio(db,datos)
        location.reload()
      }
      $("#btn-favoritos").change(function(){
        if(this.checked){
          console.log('Filtro por favoritos')
        }
        else{
          console.log('Favorito: Muestro todos');
        }
      })
      $("#btn-ocultos").change(function(){
        if(this.checked){
          console.log('Filtro por ocultos')
        }
        else{
          console.log('Oculto: Muestro todos');
        }
      })
    </script>
  </body>
</html>