<!DOCTYPE html>
<html>
  <head>
      <meta charset="utf-8">
      <meta name="format-detection" content="telephone=no">
      <meta name="msapplication-tap-highlight" content="no">
      <meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover">
      <link rel="stylesheet" href="css/fontawesome.css">
      <link rel="stylesheet" href="css/solid.css">
      <link rel="stylesheet" href="css/bootstrap.css">
      <link rel="stylesheet" href="css/index.css">
      <script src="cordova.js"></script>
  </head>
  <body class="bg-light">
    <!-- Barra superior -->
    <div class="sticky-top bg-primary d-flex flex-wrap p-2">
      <div class="col-6">
        <p class="m-2 h4"><a href="categorias.html"><i class="fa-solid fa-arrow-left"></i></a><span id="titulo"></span></p>
      </div>
      <div class="text-end col-6">
        <button id="buscar" class="btn btn-secondary me-1"><i class="fas fa-search"></i></button>
        <button data-bs-toggle="modal" data-bs-target="#modalCEjercicio" class="btn btn-primary me-1"><i class="fas fa-plus"></i></button>
      </div>
      <div id="busqueda" class="input-group sticky-top my-2 px-4" style="display:none">
        <div class="input-group-prepend">
          <span class="input-group-text bg-primary" id="basic-text1"><i class="fas fa-search text-white" aria-hidden="true"></i></span>
        </div>
        <input class="form-control py-1" id="search_text" type="text" placeholder="Buscar ejercicio" aria-label="Search">
      </div>
    </div>
    <!-- Fin barra superior -->
    
    <div id="ejercicios" class="mb-5"></div>

    <!-- Modal nuevo ejercicio -->
    <div class="modal fade" id="modalCEjercicio" tabindex="-1" aria-labelledby="modalCEjercicioLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="modalCEjercicioLabel">Crear ejercicio</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="input-group mb-2">
              <input type="text" class="form-control" autofocus placeholder="Nombre del ejercicio:" name="nombre" id="nombre" />
            </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary">Guardar</button>
          </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Fin modal nuevo ejercicio -->

    <!-- Modal editar ejercicio -->
    <div class="modal fade" id="modalUEjercicio" tabindex="-1" aria-labelledby="modalUEjercicioLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="modalUEjercicioLabel"></h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="input-group mb-2">
              <input type="text" class="form-control" autofocus placeholder="Nombre de la categoría:" name="nombre" id="nombre" />
            </div>
            <div class="input-group flex-nowrap mb-2">
              <span class="input-group-text">Color</span>
              <input type="color" class="form-control form-control-color" name="color" id="color" />
            </div>
            <p class="text-center">Días de recuperación: <output id="num">2</output></p>
            <input type="range" class="form-range" min="0" max="7" id="recuperacion" name="recuperacion" oninput="num.value = this.value" value="2" />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary">Actualizar</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Fin modal editar ejercicio -->

    <!-- Modal borrar ejercicio -->
    <div class="modal fade" id="modalDEjercicio" tabindex="-1" aria-labelledby="modalDEjercicioLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="modalDEjercicioLabel"></h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>¡Se eliminará el ejercicio y todos sus entrenamientos!</p>
            <p>Si sólo quieres que no te aparezca en pantalla, puedes ocultarlo.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary"><a class="text-decoration-none" id="eliminar">Eliminar</a></button>
          </div>
        </div>
      </div>
    </div>
    <!-- Fin modal borrar ejercicio -->

    <!-- Barra inferior -->
    <div class="align-items-center mh-45px fixed-bottom bg-primary p-2 d-flex justify-content-around" w3-include-html="footer.html"></div>
    <script src="js/footer.js"></script>
    <script>includeHTML();</script>
    <!-- Fin  barra inferior -->
    
    <!-- <script src="js/index.js"></script> -->
    <script src="js/db.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="js/bootstrap.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script>
      document.addEventListener('deviceready', async function() {
        // Conexión, insertar metricas, tipos y ejercicios
        const db = conexion();
        await insertarMetricas(db);
        await insertarTipos(db);
        await insertarEjercicios(db);
        const modalDEjercicio = document.getElementById('modalDEjercicio')
        // Obtengo el parámetro get grupo_muscular para hacer la consulta de los ejercicios correspondientes
        const urlParams = new URLSearchParams(window.location.search);
        const grupo_muscular_id = urlParams.get('grupo_muscular');
        modalDEjercicio.addEventListener('show.bs.modal', async event => {
          const boton = event.relatedTarget
          const idEjercicio = boton.getAttribute('data-bs-ejercicio')
          const ejercicio = await getEjercicios(db,`WHERE ID = ${idEjercicio}`);
          const modalTitle = modalDEjercicio.querySelector('.modal-title')
          modalTitle.textContent = ejercicio.rows.item(0).nombre;
          const modalLink = modalDEjercicio.querySelector('#eliminar')
          modalLink.href = "ejercicios.html?grupo_muscular="+grupo_muscular_id+"&eliminar="+idEjercicio;
        });
        if(urlParams.get('eliminar') != null){
          borrarEjercicio(db,urlParams.get('eliminar'));
        }
        if(urlParams.get('ocultar') != null){
          ocultarEjercicio(db,urlParams.get('ocultar'));
        }
        // Cojo el nombre del grupo muscular para cambiar el título de la ventana
        const grupo_muscular = await getCategorias(db,`WHERE ID = ${grupo_muscular_id}`);
        const nombre_grupo_muscular = grupo_muscular.rows.item(0).nombre;
        $('#titulo').text(" " + nombre_grupo_muscular);
        // Consulto todos los ejercicios de esa categoría
        const ejercicios = await getEjercicios(db,`WHERE grupo_muscular = ${grupo_muscular_id} AND oculto = 0`);
        for (let i = 0; i < ejercicios.rows.length; i++) {
            let ejercicio = ejercicios.rows.item(i);
            // Crear el div principal
            let divPrincipal = document.createElement("div");
            divPrincipal.classList.add("px-4", "my-2");

            // Crear el div interno
            let divInterno = document.createElement("div");
            divInterno.classList.add("bg-white", "rounded", "shadow-sm", "p-3", "row", "align-items-center");

            // Crear la columna 1
            let columna1 = document.createElement("div");
            columna1.classList.add("col-4");

            // Crear la imagen
            let imagen = document.createElement("img");
            imagen.classList.add("rounded-circle", "shadow", "img-fluid");
            imagen.src = ejercicio.imagen;
            columna1.appendChild(imagen);

            // Añadir la columna 1 al div interno
            divInterno.appendChild(columna1);

            // Crear la columna 2
            let columna2 = document.createElement("div");
            columna2.classList.add("col-8");

            // Crear la fila interna
            let filaInterna = document.createElement("div");
            filaInterna.classList.add("row");

            // Crear la columna 1 de la fila interna
            let columna1FilaInterna = document.createElement("div");
            columna1FilaInterna.classList.add("col-10");

            // Crear el párrafo
            let parrafo = document.createElement("p");
            let strong = document.createElement("strong");
            let u = document.createElement("u");
            let textoParrafo = document.createTextNode(ejercicio.nombre);
            u.appendChild(textoParrafo);
            strong.appendChild(u);
            parrafo.appendChild(strong);

            // Añadir el párrafo a la columna 1 de la fila interna
            columna1FilaInterna.appendChild(parrafo);

            // Añadir la columna 1 de la fila interna a la fila interna
            filaInterna.appendChild(columna1FilaInterna);

            // Crear la columna 2 de la fila interna
            let columna2FilaInterna = document.createElement("div");
            columna2FilaInterna.classList.add("col-2");

            // Crear el contenedor del menú desplegable
            let dropdown = document.createElement("div");
            dropdown.classList.add("dropdown");

            let boton = document.createElement("button");
            boton.classList.add("btn");
            boton.setAttribute("type", "button");
            boton.setAttribute("data-bs-toggle", "dropdown");
            boton.setAttribute("aria-expanded", "false");
            // Crear el ícono del menú desplegable
            let icono = document.createElement("i");
            icono.classList.add("fa-solid", "fa-ellipsis-vertical");

            // Añadir el ícono al contenedor del menú desplegable
            boton.appendChild(icono);
            dropdown.appendChild(boton);

            // Crear la lista del menú desplegable
            let lista = document.createElement("ul");
            lista.classList.add("dropdown-menu");

            // Crear los elementos de la lista
            let elementosLista = [
                { href: `ejercicios.html?ejercicio=${ejercicio.ID}`, clase: "dropdown-item", icono: "fa-info-circle", texto: " Información" },
                { href: `estadisticas.html?ejercicio=${ejercicio.ID}`, clase: "dropdown-item", icono: "fa-chart-line", texto: " Estadísticas" },
                { clase: "dropdown-item", icono: "fa-pencil", texto: " Editar", modal: "modalUEjercicio", atributo: "data-bs-ejercicio", valorAtributo: ejercicio.ID },
                { clase: "dropdown-item", icono: "fa-trash-can", texto: " Eliminar", modal: "modalDEjercicio", atributo: "data-bs-ejercicio", valorAtributo: ejercicio.ID },
                { href: `ejercicios.html?grupo_muscular=${grupo_muscular_id}&ocultar=${ejercicio.ID}`, clase: "dropdown-item", icono: "fa-eye-slash", texto: " Ocultar" }
            ];

            elementosLista.forEach(function(elemento) {
              let itemLista = document.createElement("li");
              let enlace = document.createElement("a");
              enlace.href = elemento.href || "#";
              enlace.classList.add(elemento.clase);
              let iconoLista = document.createElement("i");
              iconoLista.classList.add("fa-solid", elemento.icono);
              let textoEnlace = document.createTextNode(elemento.texto);
              enlace.appendChild(iconoLista);
              enlace.appendChild(textoEnlace);
              itemLista.appendChild(enlace);
              lista.appendChild(itemLista);
              if (elemento.modal) {
                  enlace.setAttribute("data-bs-toggle", "modal");
                  enlace.setAttribute("data-bs-target", "#" + elemento.modal);
                  enlace.setAttribute(elemento.atributo, elemento.valorAtributo);
              }
            });

            // Añadir la lista al contenedor del menú desplegable
            dropdown.appendChild(lista);

            // Añadir el contenedor del menú desplegable a la columna 2 de la fila interna
            columna2FilaInterna.appendChild(dropdown);

            // Añadir la columna 2 de la fila interna a la fila interna
            filaInterna.appendChild(columna2FilaInterna);

            // Añadir la fila interna a la columna 2
            columna2.appendChild(filaInterna);

            // Añadir la columna 2 al div interno
            divInterno.appendChild(columna2);

            // Añadir el div interno al div principal
            divPrincipal.appendChild(divInterno);
            document.getElementById("ejercicios").appendChild(divPrincipal);
        }
      },false);
      $(document).ready(function(){
        $("#buscar").on( "click", function() {
          $("#busqueda").slideToggle("fast");
        })
      });
    </script>
  </body>
</html>